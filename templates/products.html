--- START OF FILE products.html ---

{% extends "base.html" %}

{% block title %}Products - Bash Merchandise Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Products</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus"></i> Add New Product
    </button>
</div>

<!-- Products Container -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><span class="product-count">0</span> products</span> <!-- Initial count will be updated by JS -->
        <div class="d-flex gap-2">
            <input type="text" class="form-control" placeholder="Search products..." id="productSearch">
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Image</th>
                        <th scope="col">Product Name</th>
                        <th scope="col">SKU</th>
                        <th scope="col">Category</th>
                        <th scope="col" class="text-end">Unit Price</th>
                        <th scope="col" class="text-center">Stock</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <!-- Product rows will be dynamically inserted here by JavaScript -->
                    <tr>
                        <td colspan="9" class="text-center py-4">Loading products...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
        <div>
            <select class="form-select form-select-sm" id="rowsPerPage">
                <option value="10">10 rows</option>
                <option value="25" selected>25 rows</option>
                <option value="50">50 rows</option>
                <option value="100">100 rows</option>
            </select>
        </div>
        <nav aria-label="Product pagination">
            <ul class="pagination pagination-sm mb-0" id="productPagination">
                <!-- Pagination links will be dynamically inserted here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm" enctype="multipart/form-data">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="productSKU" class="form-label">SKU/Item Code</label>
                            <input type="text" class="form-control" id="productSKU" name="sku">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productCategory" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="productCategory" name="category_id" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="productPrice" class="form-label">Unit Price <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">UGX</span>
                                <input type="number" class="form-control" id="productPrice" name="price" step="1" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productStock" class="form-label">Initial Stock <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productStock" name="stock" min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label for="productStatus" class="form-label">Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="productStatus" name="status" required>
                                <option value="active" selected>Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3" id="currentImageSection" style="display:none;">
                        <label class="form-label">Current Image</label>
                        <div><img id="currentProductImagePreview" src="#" alt="Current Product Image" style="max-height: 100px; max-width: 100%; border-radius: 4px; object-fit: cover;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="productImage" class="form-label">Product Image <small class="text-muted">(Leave blank to keep current image when editing)</small></label>
                        <input type="file" class="form-control" id="productImage" name="image" accept="image/png, image/jpeg, image/gif">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast notification container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <!-- Success Toast -->
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span id="toastMessage">Operation successful!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    <!-- Error Toast (will be created by JS if needed) -->
</div>
{% endblock %}

{% block styles %}
<style>
    .product-thumbnail {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
    }
    .stock-normal { color: #198754; /* Bootstrap success green */ font-weight: 500; }
    .stock-warning { color: #ffc107; /* Bootstrap warning yellow */ font-weight: 500; }
    .stock-danger { color: #dc3545; /* Bootstrap danger red */ font-weight: 700; }
    .table th { background-color: #f8f9fa; }
    .table tr:hover { background-color: rgba(0, 123, 255, 0.05); /* Gentle blue hover */ }
    .text-danger { color: #dc3545 !important; } /* Ensure asterisk for required fields is red */
</style>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    let categoryMap = {};
    let allProducts = [];
    let currentProductId = null;

    // DOM elements
    const productSearch = document.getElementById('productSearch');
    const categoryFilterSelect = document.getElementById('categoryFilter');
    const productCategoryModalSelect = document.getElementById('productCategory'); // Added for modal dropdown
    const productsTableBody = document.getElementById('productsTableBody');
    const addProductModalEl = document.getElementById('addProductModal');
    const addProductModal = new bootstrap.Modal(addProductModalEl);
    const addProductForm = document.getElementById('addProductForm');
    const modalTitle = document.getElementById('addProductModalLabel');
    const saveProductBtn = document.getElementById('saveProductBtn');
    const successToastEl = document.getElementById('successToast');
    const bsSuccessToast = new bootstrap.Toast(successToastEl);
    const toastMessageEl = document.getElementById('toastMessage');
    const currentImageSection = document.getElementById('currentImageSection');
    const currentProductImagePreview = document.getElementById('currentProductImagePreview');
    const productImageInput = document.getElementById('productImage');

    // --- UTILITY FUNCTIONS ---
    function showSuccessToast(message) {
        toastMessageEl.textContent = message;
        bsSuccessToast.show();
    }

    function showErrorToast(message) {
        const toastContainer = document.querySelector('.toast-container');
        let errorToastEl = document.getElementById('errorToast');
        if (!errorToastEl) {
            const errorToastHTML = `
                <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span id="errorToastMessage">${message}</span>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>`;
            toastContainer.insertAdjacentHTML('beforeend', errorToastHTML);
            errorToastEl = document.getElementById('errorToast');
        } else {
            errorToastEl.querySelector('#errorToastMessage').textContent = message;
        }
        const bsErrorToast = new bootstrap.Toast(errorToastEl);
        bsErrorToast.show();
    }
    
    function resetForm() {
        addProductForm.reset(); // This will reset select to its first option
        productImageInput.value = null;
        currentProductId = null;
        modalTitle.textContent = 'Add New Product';
        currentImageSection.style.display = 'none';
        currentProductImagePreview.src = '#';
        // The #productCategory select will be reset to "Select Category" by addProductForm.reset()
    }

    // --- DATA FETCHING AND RENDERING ---
    async function initializePageData() {
        try {
            const categoriesResponse = await fetch('/api/categories');
            if (!categoriesResponse.ok) {
                console.error('Failed to fetch categories from /api/categories');
                showErrorToast('Could not load category list for filtering and mapping.');
            } else {
                const categoriesData = await categoriesResponse.json();
                console.log('Fetched categoriesData:', categoriesData);

                categoryMap = {};
                categoriesData.forEach(category => {
                    categoryMap[category.id] = category.name;
                });
                console.log('Category map populated:', categoryMap);

                // Populate main page filter dropdown
                categoryFilterSelect.innerHTML = '<option value="">All Categories</option>';
                if (categoriesData && categoriesData.length > 0) {
                    categoriesData.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categoryFilterSelect.appendChild(option);
                    });
                    console.log('Category filter dropdown populated by JavaScript.');
                }

                // --- START: Populate MODAL's category dropdown ---
                productCategoryModalSelect.innerHTML = '<option value="">Select Category</option>'; // Default for modal
                if (categoriesData && categoriesData.length > 0) {
                    categoriesData.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        productCategoryModalSelect.appendChild(option);
                    });
                    console.log('Modal category dropdown (productCategory) populated by JavaScript.');
                }
                // --- END: Populate MODAL's category dropdown ---
            }
        } catch (error) {
            console.error('Error in initializePageData (fetching categories):', error);
            showErrorToast('Error loading category list from API.');
        } finally {
            await fetchProducts();
        }
    }

    async function fetchProducts() {
        productsTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4">Loading products...</td></tr>`;
        try {
            const response = await fetch('/api/products');
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Failed to fetch products' }));
                throw new Error(errorData.error || 'Server error');
            }
            allProducts = await response.json();
            allProducts = allProducts.map((product, index) => ({...product, display_id: index + 1}));
            renderProducts();
        } catch (error) {
            console.error('Error fetching products:', error);
            showErrorToast(`Error fetching products: ${error.message}`);
            productsTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4">Could not load products.</td></tr>`;
        }
    }

    function filterAndSortProducts() {
        const searchTerm = productSearch.value.toLowerCase();
        const categoryIdFilterValue = categoryFilterSelect.value;
        let filtered = allProducts.filter(product => {
            const nameMatch = product.name.toLowerCase().includes(searchTerm);
            const skuMatch = product.sku ? product.sku.toLowerCase().includes(searchTerm) : false;
            const categoryMatch = categoryIdFilterValue === '' || product.category_id == categoryIdFilterValue;
            return (nameMatch || skuMatch) && categoryMatch;
        });
        filtered.sort((a, b) => a.display_id - b.display_id);
        return filtered;
    }

    function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(parseFloat(value))) return '0';
        return parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function renderProducts() {
        const filteredProducts = filterAndSortProducts();
        document.querySelector('.product-count').textContent = filteredProducts.length;
        productsTableBody.innerHTML = '';
        if (filteredProducts.length === 0) {
            productsTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4">No products found.</td></tr>`;
            return;
        }
        filteredProducts.forEach(product => {
            let stockClass = 'stock-normal';
            if (product.stock <= 0) stockClass = 'stock-danger';
            else if (product.stock <= 5) stockClass = 'stock-danger';
            else if (product.stock <= 10) stockClass = 'stock-warning';
            const statusBadge = product.status === 'active' ? `<span class="badge bg-success">Active</span>` : `<span class="badge bg-secondary">Inactive</span>`;
            const imageUrl = product.image_url || '/static/images/placeholder_product.png';
            const categoryName = product.category_name || categoryMap[product.category_id] || 'Uncategorized';
            const row = `
                <tr data-id="${product.id}" data-display-id="${product.display_id}">
                    <td>${product.display_id}</td>
                    <td><img src="${imageUrl}" alt="${product.name}" class="product-thumbnail"></td>
                    <td>${product.name}</td>
                    <td>${product.sku || 'N/A'}</td>
                    <td>${categoryName}</td>
                    <td class="text-end">UGX ${formatCurrency(product.price)}</td>
                    <td class="text-center ${stockClass}">${product.stock}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1 edit-product-btn" title="Edit"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-product-btn" title="Delete"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>`;
            productsTableBody.insertAdjacentHTML('beforeend', row);
        });
        attachActionListeners();
    }

    function attachActionListeners() {
        document.querySelectorAll('.edit-product-btn').forEach(btn => {
            btn.addEventListener('click', handleEditProduct);
        });
        document.querySelectorAll('.delete-product-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteProduct);
        });
    }

    // --- CRUD OPERATIONS ---
    function handleEditProduct(event) {
        const productId = event.currentTarget.closest('tr').dataset.id;
        const product = allProducts.find(p => p.id == productId);
        if (!product) {
            showErrorToast('Product not found.');
            return;
        }
        
        currentProductId = product.id;
        modalTitle.textContent = 'Edit Product';
        
        document.getElementById('productName').value = product.name;
        document.getElementById('productSKU').value = product.sku || '';
        
        // Set the category dropdown in the modal
        // Ensure productCategoryModalSelect is already populated by initializePageData
        productCategoryModalSelect.value = product.category_id || ""; // Handle if category_id is null/undefined

        document.getElementById('productPrice').value = product.price;
        document.getElementById('productStock').value = product.stock;
        document.getElementById('productStatus').value = product.status;
        document.getElementById('productDescription').value = product.description || '';
        productImageInput.value = null;

        if (product.image_url) {
            currentProductImagePreview.src = product.image_url;
            currentImageSection.style.display = 'block';
        } else {
            currentImageSection.style.display = 'none';
        }
        addProductModal.show();
    }

    async function handleDeleteProduct(event) {
        const productId = event.currentTarget.closest('tr').dataset.id;
        const product = allProducts.find(p => p.id == productId);
        if (!product) {
            showErrorToast('Product not found.');
            return;
        }
        if (confirm(`Are you sure you want to delete "${product.name}"?`)) {
            try {
                const response = await fetch(`/api/products/${productId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to delete product' }));
                    throw new Error(errorData.error || 'Server error');
                }
                allProducts = allProducts.filter(p => p.id != productId);
                allProducts = allProducts.map((p, index) => ({ ...p, display_id: index + 1 }));
                renderProducts();
                showSuccessToast('Product successfully deleted!');
            } catch (error) {
                console.error('Error deleting product:', error);
                showErrorToast(`Error deleting product: ${error.message}`);
            }
        }
    }

    async function handleSaveProduct() {
        if (!addProductForm.checkValidity()) {
            addProductForm.reportValidity();
            return;
        }
        const formData = new FormData(addProductForm);
        let url = '/api/products';
        let method = 'POST';
        if (currentProductId) {
            url = `/api/products/${currentProductId}`;
            method = 'PUT';
        }
        try {
            saveProductBtn.disabled = true;
            saveProductBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;
            const response = await fetch(url, { method: method, body: formData });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `Failed to ${currentProductId ? 'update' : 'create'} product` }));
                throw new Error(errorData.error || 'Server error during save.');
            }
            await fetchProducts();
            addProductModal.hide();
            showSuccessToast(currentProductId ? 'Product successfully updated!' : 'Product successfully added!');
        } catch (error) {
            console.error('Error saving product:', error);
            showErrorToast(`Error saving product: ${error.message}`);
        } finally {
            saveProductBtn.disabled = false;
            saveProductBtn.textContent = 'Save Product';
        }
    }

    // --- EVENT LISTENERS ---
    productSearch.addEventListener('input', renderProducts);
    categoryFilterSelect.addEventListener('change', renderProducts);
    saveProductBtn.addEventListener('click', handleSaveProduct);
    
    addProductModalEl.addEventListener('show.bs.modal', function (event) {
        if (!currentProductId) {
            resetForm();
        }
        // If editing, handleEditProduct will have already populated the form.
        // The category dropdown (productCategoryModalSelect) is populated once on page load.
    });
    addProductModalEl.addEventListener('hidden.bs.modal', resetForm);

    // Initial data load
    initializePageData();
});
</script>
{% endblock %}
--- END OF FILE products.html ---