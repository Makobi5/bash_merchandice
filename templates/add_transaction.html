{# templates/add_transaction.html #}
{% extends 'base.html' %}

{% block title %}Add New Transaction{% endblock %}

{% block styles %}
<style>
    .product-row { margin-bottom: 10px; }
    #runningTotal { font-size: 1.2em; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2>Add New Transaction</h2>
        </div>
        <div class="card-body">
            <form method="POST" id="addTransactionForm">
                {# Customer Selection #}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="customer_id" class="form-label">Customer</label>
                        <select class="form-select" id="customer_id" name="customer_id">
                            <option value="">-- Walk-in Customer --</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.phone_number or 'No Phone' }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="payment_method" class="form-label">Payment Method <span class="text-danger">*</span></label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="Cash" selected>Cash</option>
                            <option value="Mobile Money">Mobile Money</option>
                            <option value="Card">Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <hr>
                <h4>Products</h4>
                <div id="productItemsContainer">
                    {# Product rows will be added here by JavaScript #}
                    <div class="product-row row gx-2 align-items-center">
                        <div class="col-md-5">
                            <select class="form-select product-select" name="product_id[]">
                                <option value="">Select Product</option>
                                {% for product in products %}
                                    <option value="{{ product.id }}" data-price="{{ product.price }}">{{ product.name }} (Stock: {{product.stock }}) - {{ format_ugx(product.price) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control quantity-input" name="quantity[]" placeholder="Qty" min="1" value="1">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control item-total-display" readonly placeholder="Item Total">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-danger remove-product-row-btn">Remove</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-success btn-sm mt-2" id="addProductRowBtn"><i class="bi bi-plus"></i> Add Another Product</button>
                
                <hr>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="notes" class="form-label">Notes / Remarks</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>

                <div class="text-end mt-3">
                    <h4>Total Amount: <span id="runningTotal" class="text-primary">{{ format_ugx(0) }}</span></h4>
                </div>

                <div class="mt-4 d-flex justify-content-end">
                    <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary" id="saveTransactionBtn">Record Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Template for new product rows (for JavaScript) #}
<template id="productRowTemplate">
    <div class="product-row row gx-2 align-items-center">
        <div class="col-md-5">
            <select class="form-select product-select" name="product_id[]">
                <option value="">Select Product</option>
                {% for product in products %}
                    <option value="{{ product.id }}" data-price="{{ product.price }}">{{ product.name }} (Stock: {{product.stock }}) - {{ format_ugx(product.price) }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control quantity-input" name="quantity[]" placeholder="Qty" min="1" value="1">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control item-total-display" readonly placeholder="Item Total">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-sm btn-danger remove-product-row-btn">Remove</button>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const productItemsContainer = document.getElementById('productItemsContainer');
    const addProductRowBtn = document.getElementById('addProductRowBtn');
    const productRowTemplate = document.getElementById('productRowTemplate');
    const runningTotalEl = document.getElementById('runningTotal');
    const formatUgx = (value) => `UGX ${parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

    function updateTotals() {
        let grandTotal = 0;
        productItemsContainer.querySelectorAll('.product-row').forEach(row => {
            const productSelect = row.querySelector('.product-select');
            const quantityInput = row.querySelector('.quantity-input');
            const itemTotalDisplay = row.querySelector('.item-total-display');
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            
            const itemTotal = price * quantity;
            if (itemTotalDisplay) { // Check if element exists
                itemTotalDisplay.value = formatUgx(itemTotal);
            }
            grandTotal += itemTotal;
        });
        runningTotalEl.textContent = formatUgx(grandTotal);
    }

    function addRowEventListeners(row) {
        row.querySelector('.product-select').addEventListener('change', updateTotals);
        row.querySelector('.quantity-input').addEventListener('input', updateTotals);
        const removeBtn = row.querySelector('.remove-product-row-btn');
        if (removeBtn) { // First row might not have it initially
            removeBtn.addEventListener('click', function() {
                if (productItemsContainer.querySelectorAll('.product-row').length > 1) {
                    this.closest('.product-row').remove();
                    updateTotals();
                } else {
                    alert("At least one product item is required.");
                }
            });
        }
    }

    addProductRowBtn.addEventListener('click', function() {
        const newRow = productRowTemplate.content.cloneNode(true);
        productItemsContainer.appendChild(newRow);
        // Get the newly added row (it's the last child)
        const appendedRow = productItemsContainer.lastElementChild; 
        addRowEventListeners(appendedRow);
        updateTotals(); // Initial calculation for the new row
    });

    // Add listeners to the initial row
    productItemsContainer.querySelectorAll('.product-row').forEach(row => {
        addRowEventListeners(row);
        // Hide remove button if it's the only row initially
        if (productItemsContainer.querySelectorAll('.product-row').length === 1) {
            const initialRemoveBtn = row.querySelector('.remove-product-row-btn');
            if (initialRemoveBtn) initialRemoveBtn.style.display = 'none';
        }
    });
    
    updateTotals(); // Initial calculation on page load for the first row

    // Form submission - prevent if no valid products
    document.getElementById('addTransactionForm').addEventListener('submit', function(event) {
        let validProductSelected = false;
        productItemsContainer.querySelectorAll('.product-row').forEach(row => {
            const productSelect = row.querySelector('.product-select');
            if (productSelect.value) {
                validProductSelected = true;
            }
        });
        if (!validProductSelected) {
            alert('Please select at least one product.');
            event.preventDefault();
            return false;
        }
        // Add spinner to save button
        const saveBtn = document.getElementById('saveTransactionBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...`;
    });
});
</script>
{% endblock %}